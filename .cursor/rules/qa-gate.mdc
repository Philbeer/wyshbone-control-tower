---
description: Mandatory QA gate that must be passed before declaring any task complete
globs:
  - "**/*"
alwaysApply: true
---

# ðŸš¨ QA GATE - MANDATORY BEFORE TASK COMPLETION

**DO NOT declare a task "done" until the smoke test passes.**

## Quick Start

Run this command before declaring ANY task complete:

```bash
npm run smoke
```

**If it fails, fix the issue and re-run until it passes.**

## What the Smoke Test Checks

1. **Server startup** - Tower boots without crash
2. **Health check** - `GET /status.json` returns 200
3. **Runs endpoint** - `GET /tower/runs` returns 200
4. **Event ingestion** - `POST /tower/runs/log` accepts events
5. **Behaviour tests** - `GET /tower/behaviour-tests` returns 200

## Task-Specific Checks (Add 1-3 Based on Change)

After the smoke test passes, add verification specific to what changed:

| Change Type | Required Check |
|-------------|----------------|
| New API endpoint | Curl the endpoint, verify 200 response |
| Database schema | Confirm migration ran, table exists |
| UI component | Navigate to route, confirm renders |
| Evaluator logic | Trigger evaluation, check output |
| Event intake | Post event, verify ingestion |
| Investigation | Create investigation, verify diagnosis |

## Failure Protocol

If ANY check fails:
1. **Diagnose**: Read error messages in smoke test output
2. **Fix**: Address the root cause in code
3. **Re-run**: `npm run smoke` again
4. **Iterate**: Repeat until ALL checks pass

## QA Report Format

Include this at the end of your task completion:

```markdown
## QA Report

### Smoke Test
- [ ] âœ… `npm run smoke` â†’ All checks passed

### Task-Specific Checks
- [ ] âœ… [Your check 1]
- [ ] âœ… [Your check 2]

### Issues Found & Fixed
- [Describe any issues discovered during QA and how they were resolved]

### Files Changed
- `path/to/file1.ts`
- `path/to/file2.ts`
```

## Manual Verification (Optional)

If you need to manually verify specific endpoints:

```bash
# Start server
npm run dev

# In another terminal, test endpoints:
curl http://localhost:3000/status.json
curl http://localhost:3000/tower/runs
curl -X POST http://localhost:3000/tower/runs/log \
  -H "Content-Type: application/json" \
  -d '{"source":"test","userId":"manual-test","goal":"Test run"}'
```

---

**Remember**: No shortcuts. Every task must pass `npm run smoke` before completion.
